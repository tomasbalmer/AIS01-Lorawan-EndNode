# Firmware Overview  
## AIS01-LB Custom Firmware

This document provides a **high-level overview of how the firmware works**,  
how modules interact, and how the system behaves at runtime.

---

# 1. System Architecture

The firmware is composed of several independent modules:

- **AT Interface** — user interaction
- **Storage (NVMM)** — credentials, calibration, counters
- **LoRaWAN Stack** — Semtech LoRaMAC-node
- **Uplink Encoder** — builds FPorts, payloads, power profile, ACKs
- **Downlink Dispatcher** — opcode → handler table
- **Scheduler** — uplink timing + STOP-mode wake cycle
- **Power** — STOP mode, wakeup, SX1276 power control

Diagrams and internals live in `Architecture_Specification.md`.

---

# 2. Main Flow (Runtime)

```
boot
→ SystemInit
→ load storage
→ prepare LoRaWAN
→ AT ready
→ JOIN (OTAA)
→ IDLE
  → schedule uplink
  → enter STOP
  → wake via RTC
  → send uplink
  → process downlink
  → repeat
```

---

# 3. Uplink Pipeline

## Steps
1. Scheduler wakes device  
2. Encoder builds payload based on:
   - Battery level
   - Calibration state
   - Uptime
   - DR / TXP
3. LoRaMAC-node TX
4. Downlink (if present) processed via dispatcher  
5. FSM returns to IDLE

---

# 4. Downlink Processing

Each received downlink is decoded as:

```
fport
opcode
payload
```

Handlers include:

- **0xA0 — Calibration**
- **Config updates**
- **Requests for immediate uplink**

---

# 5. Calibration Flow

1. Downlink opcode `0xA0` received  
2. Payload validated  
3. Calibration state applied in RAM  
4. State persisted to NVMM  
5. ACK uplink scheduled  
6. Device returns to STOP mode

Details: `docs/firmware/implementation/Calibration_Engine.md`

---

# 6. STOP-Mode & Power Model

- STOP mode keeps:
  - RTC
  - SRAM
- SX1276 powered off between uplinks
- Wake events generated by scheduler

Target STOP current: **<20 µA**

---

# 7. File Locations (source)

- `src/app/…` — application logic  
- `src/lorawan/…` — LoRaMAC-node core  
- `src/board/…` — MCU + radio hardware drivers  
- `src/system/…` — shared utilities  

---

# 8. Source of Truth

This file complements:

- `Memory_Map.md`
- `Architecture_Specification.md`

All OEM information stays in `docs/legacy/`.
